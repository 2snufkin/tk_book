"use strict";(self.webpackChunktkbook=self.webpackChunktkbook||[]).push([[8205],{7903:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"Libraries/Liquibase In TK","title":"Liquibase In TK","description":"After analyzing the provided information, I\'ll explain the current Liquibase setup in your Tumorotek application and suggest improvements.","source":"@site/docs/Libraries/Liquibase In TK.md","sourceDirName":"Libraries","slug":"/Libraries/Liquibase In TK","permalink":"/tk_book/Libraries/Liquibase In TK","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Apache Poi","permalink":"/tk_book/Libraries/Apache Poi"},"next":{"title":"Liquibase Developer Reference Guide","permalink":"/tk_book/Libraries/Liquibase"}}');var r=s(4848),t=s(8453);const a={},o=void 0,l={},c=[{value:"Current Situation Analysis",id:"current-situation-analysis",level:2},{value:"How It Currently Works",id:"how-it-currently-works",level:2},{value:"Improvement Proposals",id:"improvement-proposals",level:2},{value:"Case 1: Intentional Change to Multiple Change Sets",id:"case-1-intentional-change-to-multiple-change-sets",level:2},{value:"Case 2: Update the Checksum for a Single Change Set",id:"case-2-update-the-checksum-for-a-single-change-set",level:2},{value:"Case 3: When to Use the Update Command",id:"case-3-when-to-use-the-update-command",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"After analyzing the provided information, I'll explain the current Liquibase setup in your Tumorotek application and suggest improvements."}),"\n",(0,r.jsx)(n.h2,{id:"current-situation-analysis",children:"Current Situation Analysis"}),"\n",(0,r.jsx)(n.p,{children:"Your application uses Liquibase for database schema management across multiple modules (webapp, model). Here's how it's currently structured:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Configuration Issues"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"liquibase.properties"})," file contains hard-coded credentials and database URLs, including some that appear to be test or development environments"]}),"\n",(0,r.jsx)(n.li,{children:"There are commented-out Oracle configurations mixed with MySQL configurations"}),"\n",(0,r.jsx)(n.li,{children:"The file contains info about usernames and passwords and lyon's url and it's committed to Git with potentially sensitive information"}),"\n",(0,r.jsx)(n.li,{children:"Modify this file on your local machine to include your url, password etc in commiting by error (already happened)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Execution Setup"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Liquibase is integrated via Maven plugins in multiple modules"}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"InitServlet"})," class appears to handle Liquibase initialization at application startup"]}),"\n",(0,r.jsxs)(n.li,{children:["Several executions are defined in the POM files to:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Copy Liquibase changelog files from webapp to other modules"}),"\n",(0,r.jsx)(n.li,{children:"Execute updates against multiple databases (tumorotek and tumorotek_codes)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Respurce Location"}),":\r\nThe sql files and changelog files are not in the same packages:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"changelogs are inside tumorotek-webapp/src/main/resources/liquibase/changelog"}),"\n",(0,r.jsx)(n.li,{children:"sql files are inside tumorotek-model/src/database/mysql and tumorotek-model/src/database/oracle"}),"\n",(0,r.jsxs)(n.li,{children:["When examining how liquibase should locate the sql files as referenced in the changelogs we see `",(0,r.jsx)("sqlFile",{encoding:"utf8",path:"../sql/mysql/tumorotek/export_mysql.sql",endDelimiter:"&&",relativeToChangelogFile:"true",stripComments:"true"}),' relativeToChangelogFile="true" is set in the changelog files, so the SQL files should be located relative to where the changelog files are positioned after the build process.']}),"\n",(0,r.jsx)(n.li,{children:"Since it's a relative path, it should be relative to the changelog file"}),"\n",(0,r.jsx)(n.li,{children:"Resources are copied from various locations during the build process"}),"\n",(0,r.jsxs)(n.li,{children:["There is a Maven configuration that copies SQL files from the ../tumorotek-install/src/assembly/sql directory to the ",(0,r.jsx)(n.code,{children:"${basedir}/target/classes/liquibase/sql"})," output directory during the validate phase of the build process, excluding any .bat and .sh files."]}),"\n",(0,r.jsxs)(n.li,{children:["No mention of copying something to target/classes/liquibase/oracle or copying changelog files to ",(0,r.jsx)(n.code,{children:"${basedir}/target/classes/liquibase/changelog"})]}),"\n",(0,r.jsxs)(n.li,{children:["However, the current setup seems to be copying SQL files to ",(0,r.jsx)(n.code,{children:"${basedir}/target/classes/liquibase/sql"})," during the build, but there's no explicit mention of copying the changelog files to a corresponding location that would maintain the expected relative paths."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"how-it-currently-works",children:"How It Currently Works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"During the Maven build, Liquibase resources are copied between modules. It's not clear why the changelogs aren't copied"}),"\n",(0,r.jsx)(n.li,{children:"The Maven Liquibase plugin executes database updates during the build process"}),"\n",(0,r.jsxs)(n.li,{children:["Additionally, the ",(0,r.jsx)(n.code,{children:"InitServlet"})," appears to run Liquibase updates at application startup"]}),"\n",(0,r.jsx)(n.li,{children:"There are hardcoded configurations alongside property-based configurations"}),"\n",(0,r.jsx)(n.li,{children:"Currently, liquibase can't function correctly with the current liquibase.properties file"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"improvement-proposals",children:"Improvement Proposals"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Environment-Specific Configuration"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Replace the hardcoded ",(0,r.jsx)(n.code,{children:"liquibase.properties"})," file with environment-specific properties files (like with tumorotek.properties)"]}),"\n",(0,r.jsxs)(n.li,{children:["Create template files like ",(0,r.jsx)(n.code,{children:"liquibase-{env}.properties"})," (dev, test, prod) that are not committed to Git"]}),"\n",(0,r.jsx)(n.li,{children:"Use Maven profiles to select the appropriate properties file during build"}),"\n",(0,r.jsx)(n.li,{}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-properties",children:"# Example src/main/resources/liquibase/liquibase-template.properties\r\n# (NOT committed to Git)\r\nchangeLogFile=src/main/resources/liquibase/changelog/db.changelog-master.xml\r\ndriver=${db.driver}\r\nurl=${db.url}\r\nusername=${db.username}\r\npassword=${db.password}\r\ninterfacages.schema=${db.interfacages.schema}\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Credentials Management"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Move database credentials out of properties files and use environment variables or a secure credential store"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Execution Strategy"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Decide on a consistent approach for when Liquibase runs:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Option 1: Run exclusively during build (recommended for production)"}),"\n",(0,r.jsx)(n.li,{children:"Option 2: Run at application startup (good for development)"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Don't mix both approaches as it can lead to inconsistencies"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Module Organization"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Centralize Liquibase resources in one module instead of copying between modules."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"handling-liquibase-checksum-mismatch-errors-in-tumorotek",children:"Handling Liquibase Checksum Mismatch Errors in TumoroteK"}),"\n",(0,r.jsxs)(n.p,{children:["In TumoroteK, the ",(0,r.jsx)(n.strong,{children:"liquibase.properties"})," file is tracked in Git, so it is best not to modify it directly.\r\nInstead, override properties at runtime using command-line parameters to avoid accidentally pushing local configuration changes.\r\nLiquibase calculates a checksum for each change set when it is first executed against the database. If a change set is modified later, the recalculated checksum will differ from the stored value, and Liquibase will report a checksum mismatch error."]}),"\n",(0,r.jsx)(n.p,{children:"Below are three common scenarios and how to address them."}),"\n",(0,r.jsx)(n.h2,{id:"case-1-intentional-change-to-multiple-change-sets",children:"Case 1: Intentional Change to Multiple Change Sets"}),"\n",(0,r.jsxs)(n.p,{children:["When you have intentionally modified one or more change sets (e.g., to fix an issue or update the schema), you need to update Liquibase\u2019s stored checksums. To do this, run the ",(0,r.jsx)(n.strong,{children:"clearCheckSums"})," command without modifying your tracked ",(0,r.jsx)(n.strong,{children:"liquibase.properties"})," file. Instead, provide your custom properties at the command line:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'liquibase \\\r\n  --url="jdbc:mysql://localhost:3306/{db_name}" \\\r\n  --driver="com.mysql.cj.jdbc.Driver" \\\r\n  --username="{username}" \\\r\n  --password="{password}" \\\r\n  --classpath="{path/to/mysql-connector-j-x.x.x.jar}" \\\r\n  --searchPath="{your_path}/code/TumoroteK/tumorotek-install/src/assembly/sql, {your_path}/TumoroteK/tumorotek-webapp/src/main/resources" \\\r\n  --log-level=DEBUG \\\r\n  clearCheckSums\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Replace the placeholders as follows:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{db_name}"}),": Your database name."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{username}"})," and ",(0,r.jsx)(n.code,{children:"{password}"}),": Your database credentials."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{path/to/mysql-connector-j-x.x.x.jar}"}),": The full path to your MySQL Connector/J JAR file."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{your_path}"}),": The base path where your TumoroteK code resides."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This command clears all stored checksums, prompting Liquibase to recalculate them based on the current state of the change sets."}),"\n",(0,r.jsx)(n.h2,{id:"case-2-update-the-checksum-for-a-single-change-set",children:"Case 2: Update the Checksum for a Single Change Set"}),"\n",(0,r.jsxs)(n.p,{children:["If you need to update the checksum for just one change set (for example, when only one file has been intentionally modified), you can limit the command to that specific file using the ",(0,r.jsx)(n.code,{children:"--changeLogFile"})," parameter. For example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'liquibase \\\r\n  --url="jdbc:mysql://localhost:3306/{db_name}" \\\r\n  --driver="com.mysql.cj.jdbc.Driver" \\\r\n  --username="{username}" \\\r\n  --password="{password}" \\\r\n  --classpath="{path/to/mysql-connector-j-x.x.x.jar}" \\\r\n  --searchPath="{your_path}/code/TumoroteK/tumorotek-install/src/assembly/sql, {your_path}/TumoroteK/tumorotek-webapp/src/main/resources" \\\r\n  --log-level=DEBUG \\\r\n  --changeLogFile="liquibase/changelog/db.changelog-2.3.1.0_4_TK-533.xml" \\\r\n  clearCheckSums\n'})}),"\n",(0,r.jsx)(n.p,{children:"This command targets only the specified change set file, in this example liquibase/changelog/db.changelog-2.3.1.0_4_TK-533.xml\r\n, updating its checksum without affecting others."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"case-3-when-to-use-the-update-command",children:"Case 3: When to Use the Update Command"}),"\n",(0,r.jsxs)(n.p,{children:["After resolving checksum mismatches using ",(0,r.jsx)(n.strong,{children:"clearCheckSums"})," (whether for all change sets or a single file), you should run the ",(0,r.jsx)(n.strong,{children:"update"})," command to apply any pending changes to the database schema. This is especially important if you have new change sets or modifications waiting to be applied.\r\nTroubleshooting Update Command Issues Due to Relative SQL File Paths"]}),"\n",(0,r.jsx)(n.p,{children:"In  TumoroteK project, the SQL files referenced in some change sets are declared as relative to the changelog file. However, these SQL files are not located in the same package as the changelog file. Based on my personal experience, I think this discrepancy is the source of problems when running the update command. The relative paths defined in the change sets do not resolve as expected, which has prevented successful execution of the command in my setup."}),"\n",(0,r.jsx)(n.p,{children:"Here\u2019s an example of running the update command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'liquibase \\\r\n  --url="jdbc:mysql://localhost:3306/{db_name}" \\\r\n  --driver="com.mysql.cj.jdbc.Driver" \\\r\n  --username="{username}" \\\r\n  --password="{password}" \\\r\n  --classpath="{path/to/mysql-connector-j-x.x.x.jar}" \\\r\n  --searchPath="{your_path}/code/TumoroteK/tumorotek-install/src/assembly/sql, {your_path}/TumoroteK/tumorotek-webapp/src/main/resources" \\\r\n  --log-level=DEBUG \\\r\n  update\n'})}),"\n",(0,r.jsx)(n.p,{children:"Running this command applies the changes defined in your changelog files to your database, ensuring that your schema is up-to-date."}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Do not modify the tracked ",(0,r.jsx)(n.code,{children:"liquibase.properties"})," file in TumoroteK."]})," Always override properties on the command line to avoid accidental Git commits."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Case 1:"})," Use ",(0,r.jsx)(n.strong,{children:"clearCheckSums"})," for intentional changes affecting multiple change sets."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Case 2:"})," Use ",(0,r.jsx)(n.strong,{children:"clearCheckSums"})," with the ",(0,r.jsx)(n.code,{children:"--changeLogFile"})," parameter to update a single change set\u2019s checksum."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Case 3:"})," Run the ",(0,r.jsx)(n.strong,{children:"update"})," command after clearing checksums to apply any pending changes to the database."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var i=s(6540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);